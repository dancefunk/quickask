import{_ as s,o as n,c as a,a as p}from"./app-c220f801.js";const e="/dist/assets/images/mysql/11.png",o={},t=p(`<h3 id="mysql数据备份" tabindex="-1"><a class="header-anchor" href="#mysql数据备份" aria-hidden="true">#</a> Mysql数据备份</h3><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code>我们试着想一想<span class="token punctuation">,</span> 在生产环境中什么最重要？
如果我们服务器的硬件坏了可以维修或者换新<span class="token punctuation">,</span> 软件问题可以修复或重新安装<span class="token punctuation">,</span> 但是如果数据没了呢？这可能是最恐怖的事情了吧<span class="token punctuation">,</span> 
我感觉在生产环境中应该没有什么比数据跟更为重要<span class="token operator">.</span> 那么我们该如何保证数据不丢失、或者丢失后可以快速恢复呢？
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="为什么需要备份数据" tabindex="-1"><a class="header-anchor" href="#为什么需要备份数据" aria-hidden="true">#</a> 为什么需要备份数据？</h3><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code>其实在前言中也大概说明了为什么要备份数据<span class="token punctuation">,</span> 但是我们还是应该具体了解一下为什么要备份数据

在生产环境中我们数据库可能会遭遇各种各样的不测从而导致数据丢失<span class="token punctuation">,</span> 大概分为以下几种<span class="token operator">.</span>

    硬件故障

    软件故障

    自然灾害

    黑客攻击

    误操作 <span class="token punctuation">(</span>占比最大<span class="token punctuation">)</span>

所以<span class="token punctuation">,</span> 为了在数据丢失之后能够恢复数据<span class="token punctuation">,</span> 我们就需要定期的备份数据<span class="token punctuation">,</span> 备份数据的策略要根据不同的应用场景进行定制<span class="token punctuation">,</span> 
大致有几个参考数值<span class="token punctuation">,</span> 我们可以根据这些数值从而定制符合特定环境中的数据备份策略

    能够容忍丢失多少数据

    恢复数据需要多长时间

    需要恢复哪一些数据
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="数据的备份类型" tabindex="-1"><a class="header-anchor" href="#数据的备份类型" aria-hidden="true">#</a> 数据的备份类型</h3><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code>数据的备份类型根据其自身的特性主要分为以下几组
	完全备份
	部分备份

完全备份指的是备份整个数据集<span class="token punctuation">(</span> 即整个数据库 <span class="token punctuation">)</span>、部分备份指的是备份部分数据集<span class="token punctuation">(</span>例如<span class="token punctuation">:</span> 只备份一个表<span class="token punctuation">)</span>

而部分备份又分为以下两种

    增量备份

    差异备份

增量备份指的是备份自上一次备份以来<span class="token punctuation">(</span>增量或完全<span class="token punctuation">)</span>以来变化的数据<span class="token punctuation">;</span> 特点<span class="token punctuation">:</span> 节约空间、还原麻烦 
差异备份指的是备份自上一次完全备份以来变化的数据 特点<span class="token punctuation">:</span> 浪费空间、还原比增量备份简单
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+e+`" alt=""></p><h3 id="mysql备份数据的方式" tabindex="-1"><a class="header-anchor" href="#mysql备份数据的方式" aria-hidden="true">#</a> MySQL备份数据的方式</h3><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code>在MySQl中我们备份数据一般有几种方式

    热备份

    温备份

    冷备份

    热备份指的是当数据库进行备份时<span class="token punctuation">,</span> 数据库的读写操作均不是受影响 
    温备份指的是当数据库进行备份时<span class="token punctuation">,</span> 数据库的读操作可以执行<span class="token punctuation">,</span> 但是不能执行写操作 
    冷备份指的是当数据库进行备份时<span class="token punctuation">,</span> 数据库不能进行读写操作<span class="token punctuation">,</span> 即数据库要下线

MySQL中进行不同方式的备份还要考虑存储引擎是否支持

    MyISAM 

     热备 ×

     温备 √

     冷备 √

    InnoDB

     热备 √

     温备 √

     冷备 √

我们在考虑完数据在备份时<span class="token punctuation">,</span> 数据库的运行状态之后还需要考虑对于MySQL数据库中数据的备份方式

物理备份一般就是通过tar<span class="token punctuation">,</span>cp等命令直接打包复制数据库的数据文件达到备份的效果 
逻辑备份一般就是通过特定工具从数据库中导出数据并另存备份<span class="token punctuation">(</span>逻辑备份会丢失数据精度<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="备份需要考虑的问题" tabindex="-1"><a class="header-anchor" href="#备份需要考虑的问题" aria-hidden="true">#</a> 备份需要考虑的问题</h3><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code>定制备份策略前<span class="token punctuation">,</span> 我们还需要考虑一些问题

我们要备份什么<span class="token operator">?</span>

一般情况下<span class="token punctuation">,</span> 我们需要备份的数据分为以下几种

    数据

    二进制日志<span class="token punctuation">,</span> InnoDB事务日志

    代码<span class="token punctuation">(</span>存储过程、存储函数、触发器、事件调度器<span class="token punctuation">)</span>

    服务器配置文件

备份工具：这里我们列举出常用的几种备份工具
 
mysqldump <span class="token punctuation">:</span> 逻辑备份工具<span class="token punctuation">,</span> 适用于所有的存储引擎<span class="token punctuation">,</span> 支持温备、完全备份、部分备份、对于InnoDB存储引擎支持热备 

cp<span class="token punctuation">,</span> tar 等归档复制工具<span class="token punctuation">:</span> 物理备份工具<span class="token punctuation">,</span> 适用于所有的存储引擎<span class="token punctuation">,</span> 冷备、完全备份、部分备份 

lvm2 snapshot<span class="token punctuation">:</span> 几乎热备<span class="token punctuation">,</span> 借助文件系统管理工具进行备份 

mysqlhotcopy<span class="token punctuation">:</span> 名不副实的的一个工具<span class="token punctuation">,</span> 几乎冷备<span class="token punctuation">,</span> 仅支持MyISAM存储引擎 

xtrabackup<span class="token punctuation">:</span> 一款非常强大的InnoDB<span class="token operator">/</span>XtraDB热备工具<span class="token punctuation">,</span> 支持完全备份、增量备份<span class="token punctuation">,</span> 由percona提供
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="设计合适的备份策略" tabindex="-1"><a class="header-anchor" href="#设计合适的备份策略" aria-hidden="true">#</a> 设计合适的备份策略</h3><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code>针对不同的场景下<span class="token punctuation">,</span> 我们应该制定不同的备份策略对数据库进行备份<span class="token punctuation">,</span> 一般情况下<span class="token punctuation">,</span> 备份策略一般为以下三种

    直接cp<span class="token punctuation">,</span>tar复制数据库文件

    mysqldump<span class="token operator">+</span>复制<span class="token constant">BIN</span> <span class="token constant">LOGS</span>

    lvm2快照<span class="token operator">+</span>复制<span class="token constant">BIN</span> <span class="token constant">LOGS</span>

    xtrabackup

以上的几种解决方案分别针对于不同的场景

    如果数据量较小<span class="token punctuation">,</span> 可以使用第一种方式<span class="token punctuation">,</span> 直接复制数据库文件

    如果数据量还行<span class="token punctuation">,</span> 可以使用第二种方式<span class="token punctuation">,</span> 先使用mysqldump对数据库进行完全备份<span class="token punctuation">,</span> 然后定期备份<span class="token constant">BINARY</span> <span class="token constant">LOG</span>达到增量备份的效果

    如果数据量一般<span class="token punctuation">,</span> 而又不过分影响业务运行<span class="token punctuation">,</span> 可以使用第三种方式<span class="token punctuation">,</span> 使用lvm2的快照对数据文件进行备份<span class="token punctuation">,</span> 而后定期备份<span class="token constant">BINARY</span> <span class="token constant">LOG</span>达到增量备份的效果

    如果数据量很大<span class="token punctuation">,</span> 而又不过分影响业务运行<span class="token punctuation">,</span> 可以使用第四种方式<span class="token punctuation">,</span> 使用xtrabackup进行完全备份后<span class="token punctuation">,</span> 定期使用xtrabackup进行增量备份或差异备份
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="使用cp进行备份" tabindex="-1"><a class="header-anchor" href="#使用cp进行备份" aria-hidden="true">#</a> 使用cp进行备份</h3><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code>mysql<span class="token operator">&gt;</span> <span class="token constant">SHOW</span> <span class="token constant">DATABASES</span><span class="token punctuation">;</span>    <span class="token comment">#查看当前的数据库, 我们的数据库为employees</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token class-name">Database</span>           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token class-name">information_schema</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">employees</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">mysql</span>              <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">test</span>               <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token number">4</span> rows in <span class="token function">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">USE</span> <span class="token package">employees</span><span class="token punctuation">;</span>
Database changed
mysql<span class="token operator">&gt;</span> <span class="token constant">SHOW</span> <span class="token constant">TABLES</span><span class="token punctuation">;</span>         <span class="token comment">#查看当前库中的表</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token class-name">Tables_in_employees</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token class-name">departments</span>         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">dept_emp</span>            <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">dept_manager</span>        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">employees</span>           <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">salaries</span>            <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">titles</span>              <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token number">6</span> rows in <span class="token function">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token constant">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token constant">FROM</span> employees<span class="token punctuation">;</span>   <span class="token comment">#由于篇幅原因, 我们这里只看一下employees的行数为300024</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token class-name">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span>   <span class="token number">300024</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token number">1</span> row in <span class="token function">set</span> <span class="token punctuation">(</span><span class="token number">0.05</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token constant">FLUSH</span> <span class="token constant">TABLES</span> <span class="token constant">WITH</span> <span class="token constant">READ</span> <span class="token constant">LOCK</span><span class="token punctuation">;</span>    <span class="token comment">#向所有表施加读锁</span>
Query <span class="token constant">OK</span><span class="token punctuation">,</span> <span class="token number">0</span> rows <span class="token function">affected</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># mkdir /backup   #创建文件夹存放备份数据库文件</span>
<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># cp -a /var/lib/mysql/* /backup     #保留权限的拷贝源数据文件</span>
<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># ls /backup   #查看目录下的文件</span>
employees  ibdata1  ib_logfile0  ib_logfile1  mysql  mysql<span class="token operator">.</span>sock  test

模拟数据丢失并恢复

<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># rm -rf /var/lib/mysql/*    #删除数据库的所有文件</span>
<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># service mysqld restart   #重启MySQL, 如果是编译安装的应该不能启动, 如果rpm安装则会重新初始化数据库</span>


mysql<span class="token operator">&gt;</span> <span class="token constant">SHOW</span> <span class="token constant">DATABASES</span><span class="token punctuation">;</span>    <span class="token comment">#因为我们是rpm安装的, 连接到MySQL进行查看, 发现数据丢失了！</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token class-name">Database</span>           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token class-name">information_schema</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">mysql</span>              <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">test</span>               <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token number">3</span> rows in <span class="token function">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># rm -rf /var/lib/mysql/*    #这一步可以不做</span>
<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># cp -a /backup/* /var/lib/mysql/    #将备份的数据文件拷贝回去</span>
<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># service mysqld restart  #重启MySQL</span>


<span class="token comment">#重新连接数据并查看</span>

mysql<span class="token operator">&gt;</span> <span class="token constant">SHOW</span> <span class="token constant">DATABASES</span><span class="token punctuation">;</span>    <span class="token comment">#数据库已恢复</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token class-name">Database</span>           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token class-name">information_schema</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">employees</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">mysql</span>              <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">test</span>               <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token number">4</span> rows in <span class="token function">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">USE</span> <span class="token package">employees</span><span class="token punctuation">;</span>      

mysql<span class="token operator">&gt;</span> <span class="token constant">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token constant">FROM</span> employees<span class="token punctuation">;</span>    <span class="token comment">#表的行数没有变化</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token class-name">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span>   <span class="token number">300024</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token number">1</span> row in <span class="token function">set</span> <span class="token punctuation">(</span><span class="token number">0.06</span> sec<span class="token punctuation">)</span>

<span class="token comment">##完成</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="使用mysqldump-复制binary-log备份" tabindex="-1"><a class="header-anchor" href="#使用mysqldump-复制binary-log备份" aria-hidden="true">#</a> 使用mysqldump+复制BINARY LOG备份</h3><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code>我们这里使用的是使用yum安装的mysql<span class="token operator">-</span><span class="token number">5.1</span>的版本<span class="token punctuation">,</span> 使用的数据集为从网络上找到的一个员工数据库

我们通过mysqldump进行一次完全备份<span class="token punctuation">,</span> 再修改表中的数据<span class="token punctuation">,</span> 然后再通过binary log进行恢复 二进制日志需要在mysql配置文件中添加 log_bin<span class="token operator">=</span>on 开启
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token comment">#基本语法格式</span>

shell<span class="token operator">&gt;</span> mysqldump <span class="token punctuation">[</span>options<span class="token punctuation">]</span> db_name <span class="token punctuation">[</span>tbl_name <span class="token operator">...</span><span class="token punctuation">]</span>    恢复需要手动<span class="token constant">CRATE</span> <span class="token constant">DATABASES</span>
shell<span class="token operator">&gt;</span> mysqldump <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token operator">--</span>databases db_name <span class="token operator">...</span>   恢复不需要手动创建数据库
shell<span class="token operator">&gt;</span> mysqldump <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token operator">--</span>all<span class="token operator">-</span>databases           恢复不需要手动创建数据库


其他选项<span class="token punctuation">:</span>
     <span class="token operator">-</span><span class="token constant">E</span><span class="token punctuation">,</span> <span class="token operator">--</span>events<span class="token punctuation">:</span> 备份事件调度器
     <span class="token operator">-</span><span class="token constant">R</span><span class="token punctuation">,</span> <span class="token operator">--</span>routines<span class="token punctuation">:</span> 备份存储过程和存储函数
     <span class="token operator">--</span>triggers<span class="token punctuation">:</span> 备份表的触发器<span class="token punctuation">;</span> <span class="token operator">--</span>skip<span class="token operator">-</span>triggers 
     <span class="token operator">--</span>master<span class="token operator">-</span>date<span class="token punctuation">[</span><span class="token operator">=</span>value<span class="token punctuation">]</span>  
         <span class="token number">1</span><span class="token punctuation">:</span> 记录为<span class="token constant">CHANGE</span> <span class="token constant">MASTER</span> <span class="token constant">TO</span> 语句、语句不被注释
         <span class="token number">2</span><span class="token punctuation">:</span> 记录为注释的<span class="token constant">CHANGE</span> <span class="token constant">MASTER</span> <span class="token constant">TO</span>语句
         基于二进制还原只能全库还原

     <span class="token operator">--</span>flush<span class="token operator">-</span>logs<span class="token punctuation">:</span> 日志滚动
         锁定表完成后执行日志滚动


mysql<span class="token operator">&gt;</span> <span class="token constant">SHOW</span> <span class="token constant">DATABASES</span><span class="token punctuation">;</span>    <span class="token comment">#查看当前的数据库, 我们的数据库为employees</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token class-name">Database</span>           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token class-name">information_schema</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">employees</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">mysql</span>              <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">test</span>               <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token number">4</span> rows in <span class="token function">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">USE</span> <span class="token package">employees</span><span class="token punctuation">;</span>
Database changed
mysql<span class="token operator">&gt;</span> <span class="token constant">SHOW</span> <span class="token constant">TABLES</span><span class="token punctuation">;</span>         <span class="token comment">#查看当前库中的表</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token class-name">Tables_in_employees</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token class-name">departments</span>         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">dept_emp</span>            <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">dept_manager</span>        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">employees</span>           <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">salaries</span>            <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">titles</span>              <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token number">6</span> rows in <span class="token function">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token constant">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token constant">FROM</span> employees<span class="token punctuation">;</span>   <span class="token comment">#由于篇幅原因, 我们这里只看一下employees的行数为300024</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token class-name">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span>   <span class="token number">300024</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token number">1</span> row in <span class="token function">set</span> <span class="token punctuation">(</span><span class="token number">0.05</span> sec<span class="token punctuation">)</span>


使用mysqldump备份数据库


<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># mysql -e &#39;SHOW MASTER STATUS&#39;   #查看当前二进制文件的状态, 并记录下position的数字</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token class-name">File</span>             <span class="token operator">|</span> <span class="token class-name">Position</span> <span class="token operator">|</span> <span class="token class-name">Binlog_Do_DB</span> <span class="token operator">|</span> <span class="token class-name">Binlog_Ignore_DB</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token class-name">mysql</span><span class="token operator">-</span>bin<span class="token operator">.</span><span class="token number">000003</span> <span class="token operator">|</span>      <span class="token number">106</span> <span class="token operator">|</span>              <span class="token operator">|</span>                  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>

<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># mysqldump --all-databases --lock-all-tables  &gt; backup.sql   #备份数据库到backup.sql文件中</span>

mysql<span class="token operator">&gt;</span> <span class="token constant">CREATE</span> <span class="token constant">DATABASE</span> <span class="token constant">TEST1</span><span class="token punctuation">;</span>   <span class="token comment">#创建一个数据库</span>
Query <span class="token constant">OK</span><span class="token punctuation">,</span> <span class="token number">1</span> row <span class="token function">affected</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token constant">SHOW</span> <span class="token constant">MASTER</span> <span class="token constant">STATUS</span><span class="token punctuation">;</span>   <span class="token comment">#记下现在的position</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token class-name">File</span>             <span class="token operator">|</span> <span class="token class-name">Position</span> <span class="token operator">|</span> <span class="token class-name">Binlog_Do_DB</span> <span class="token operator">|</span> <span class="token class-name">Binlog_Ignore_DB</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token class-name">mysql</span><span class="token operator">-</span>bin<span class="token operator">.</span><span class="token number">000003</span> <span class="token operator">|</span>      <span class="token number">191</span> <span class="token operator">|</span>              <span class="token operator">|</span>                  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token number">1</span> row in <span class="token function">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># cp /var/lib/mysql/mysql-bin.000003 /root  #备份二进制文件</span>
<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># service mysqld stop   #停止MySQL</span>
<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># rm -rf /var/lib/mysql/*   #删除所有的数据文件</span>
<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># service mysqld start    #启动MySQL, 如果是编译安装的应该不能启动(需重新初始化), 如果rpm安装则会重新初始化数据库</span>


mysql<span class="token operator">&gt;</span> <span class="token constant">SHOW</span> <span class="token constant">DATABASES</span><span class="token punctuation">;</span>   <span class="token comment">#查看数据库, 数据丢失!</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token class-name">Database</span>           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token class-name">information_schema</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">mysql</span>              <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">test</span>               <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token number">3</span> rows in <span class="token function">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token constant">SET</span> sql_log_bin<span class="token operator">=</span><span class="token constant">OFF</span><span class="token punctuation">;</span>   <span class="token comment">#暂时先将二进制日志关闭  </span>
Query <span class="token constant">OK</span><span class="token punctuation">,</span> <span class="token number">0</span> rows <span class="token function">affected</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>


mysql<span class="token operator">&gt;</span> source backup<span class="token operator">.</span>sql  <span class="token comment">#恢复数据，所需时间根据数据库时间大小而定</span>

mysql<span class="token operator">&gt;</span> <span class="token constant">SET</span> sql_log_bin<span class="token operator">=</span><span class="token constant">ON</span><span class="token punctuation">;</span> 开启二进制日志

mysql<span class="token operator">&gt;</span> <span class="token constant">SHOW</span> <span class="token constant">DATABASES</span><span class="token punctuation">;</span>   <span class="token comment">#数据库恢复, 但是缺少TEST1</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token class-name">Database</span>           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token class-name">information_schema</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">employees</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">mysql</span>              <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">test</span>               <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token number">4</span> rows in <span class="token function">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># mysqlbinlog --start-position=106 --stop-position=191 mysql-bin.000003 | mysql employees #通过二进制日志增量恢复数据</span>

mysql<span class="token operator">&gt;</span> <span class="token constant">SHOW</span> <span class="token constant">DATABASES</span><span class="token punctuation">;</span>    <span class="token comment">#现在TEST1出现了！</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token class-name">Database</span>           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token class-name">information_schema</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">TEST1</span>              <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">employees</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">mysql</span>              <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">test</span>               <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token number">5</span> rows in <span class="token function">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="使用lvm2快照备份数据" tabindex="-1"><a class="header-anchor" href="#使用lvm2快照备份数据" aria-hidden="true">#</a> 使用lvm2快照备份数据</h3><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token constant">LVM</span>快照简单来说就是将所快照源分区一个时间点所有文件的元数据进行保存，
如果源文件没有改变，那么访问快照卷的相应文件则直接指向源分区的源文件，
如果源文件发生改变，则快照卷中与之对应的文件不会发生改变。快照卷主要用于辅助备份文件。 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>部署lvm环境</strong></li></ul><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code>添加硬盘<span class="token punctuation">;</span> 这里我们直接实现<span class="token constant">SCSI</span>硬盘的热插拔<span class="token punctuation">,</span> 首先在虚拟机中添加一块硬盘<span class="token punctuation">,</span> 不重启

<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># ls /dev/sd*   #只有以下几块硬盘, 但是我们不重启可以让系统识别新添加的硬盘</span>
<span class="token operator">/</span>dev<span class="token operator">/</span>sda  <span class="token operator">/</span>dev<span class="token operator">/</span>sda1  <span class="token operator">/</span>dev<span class="token operator">/</span>sda2

<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># echo &#39;- - -&#39; &gt; /sys/class/scsi_host/host0/scan </span>
<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># echo &#39;- - -&#39; &gt; /sys/class/scsi_host/host1/scan </span>
<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># echo &#39;- - -&#39; &gt; /sys/class/scsi_host/host2/scan </span>

<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># ls /dev/sd*    #看！sdb识别出来了</span>
<span class="token operator">/</span>dev<span class="token operator">/</span>sda  <span class="token operator">/</span>dev<span class="token operator">/</span>sda1  <span class="token operator">/</span>dev<span class="token operator">/</span>sda2  <span class="token operator">/</span>dev<span class="token operator">/</span>sdb


<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># fdisk /dev/sdb   #分区</span>
Device contains neither a valid <span class="token constant">DOS</span> partition table<span class="token punctuation">,</span> nor Sun<span class="token punctuation">,</span> <span class="token constant">SGI</span> <span class="token keyword">or</span> <span class="token constant">OSF</span> disklabel
Building a <span class="token keyword">new</span> <span class="token class-name">DOS</span> disklabel with disk identifier <span class="token number">0xd353d192</span><span class="token operator">.</span>
Changes will remain in memory only<span class="token punctuation">,</span> until you decide to write them<span class="token operator">.</span>
After that<span class="token punctuation">,</span> of course<span class="token punctuation">,</span> the previous content won<span class="token string single-quoted-string">&#39;t be recoverable.

Warning: invalid flag 0x0000 of partition table 4 will be corrected by w(rite)

WARNING: DOS-compatible mode is deprecated. It&#39;</span>s strongly recommended to
         <span class="token keyword">switch</span> off the <span class="token function">mode</span> <span class="token punctuation">(</span>command <span class="token string single-quoted-string">&#39;c&#39;</span><span class="token punctuation">)</span> <span class="token keyword">and</span> change display units to
         <span class="token function">sectors</span> <span class="token punctuation">(</span>command <span class="token string single-quoted-string">&#39;u&#39;</span><span class="token punctuation">)</span><span class="token operator">.</span>

<span class="token function">Command</span> <span class="token punctuation">(</span>m <span class="token keyword">for</span> help<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name return-type">n</span>
Command action
   e   extended
   p   primary <span class="token function">partition</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">)</span>
p
Partition <span class="token function">number</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token number">1</span>
First <span class="token function">cylinder</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span><span class="token number">2610</span><span class="token punctuation">,</span> <span class="token keyword">default</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span> 
<span class="token class-name return-type">Using</span> <span class="token keyword">default</span> value <span class="token number">1</span>
Last cylinder<span class="token punctuation">,</span> <span class="token operator">+</span>cylinders <span class="token keyword">or</span> <span class="token operator">+</span>size<span class="token punctuation">{</span><span class="token constant">K</span><span class="token punctuation">,</span><span class="token constant">M</span><span class="token punctuation">,</span><span class="token constant">G</span><span class="token punctuation">}</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span><span class="token number">2610</span><span class="token punctuation">,</span> <span class="token keyword">default</span> <span class="token number">2610</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token operator">+</span><span class="token number">15</span>G

<span class="token function">Command</span> <span class="token punctuation">(</span>m <span class="token keyword">for</span> help<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name return-type">t</span>
Selected partition <span class="token number">1</span>
Hex <span class="token function">code</span> <span class="token punctuation">(</span>type <span class="token constant">L</span> to <span class="token keyword">list</span> codes<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token number">8</span>e
Changed system type of partition <span class="token number">1</span> to <span class="token number">8</span>e <span class="token punctuation">(</span>Linux <span class="token constant">LVM</span><span class="token punctuation">)</span>

<span class="token function">Command</span> <span class="token punctuation">(</span>m <span class="token keyword">for</span> help<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name return-type">w</span>
The partition table has been altered<span class="token operator">!</span>

Calling <span class="token function">ioctl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> to re<span class="token operator">-</span>read partition table<span class="token operator">.</span>
Syncing disks<span class="token operator">.</span>
You have <span class="token keyword">new</span> <span class="token class-name">mail</span> in <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>spool<span class="token operator">/</span>mail<span class="token operator">/</span>root
<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># partx -a /dev/sdb</span>
<span class="token constant">BLKPG</span><span class="token punctuation">:</span> Device <span class="token keyword">or</span> resource busy
error adding partition <span class="token number">1</span>

<span class="token comment">##创建逻辑卷</span>
<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># pvcreate /dev/sdb1</span>
  Physical volume <span class="token string double-quoted-string">&quot;/dev/sdb1&quot;</span> successfully created
<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># vgcreate myvg /dev/sdb1 </span>
  Volume group <span class="token string double-quoted-string">&quot;myvg&quot;</span> successfully created
<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># lvcreate -n mydata -L 5G myvg </span>
  Logical volume <span class="token string double-quoted-string">&quot;mydata&quot;</span> created<span class="token operator">.</span>

<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># mkfs.ext4 /dev/mapper/myvg-mydata   #格式化</span>
<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># mkdir /lvm_data</span>
<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># mount /dev/mapper/myvg-mydata /lvm_data  #挂载到/lvm_data</span>


<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># vim /etc/my.cnf    #修改mysql配置文件的datadir如下</span>

datadir<span class="token operator">=</span><span class="token operator">/</span>lvm_data

<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># service mysqld restart  #重启MySQL</span>

<span class="token comment">####重新导入employees数据库########略过####</span>


mysql<span class="token operator">&gt;</span> <span class="token constant">SHOW</span> <span class="token constant">DATABASES</span><span class="token punctuation">;</span>    <span class="token comment">#查看当前的数据库, 我们的数据库为employees</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token class-name">Database</span>           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token class-name">information_schema</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">employees</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">mysql</span>              <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">test</span>               <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token number">4</span> rows in <span class="token function">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">USE</span> <span class="token package">employees</span><span class="token punctuation">;</span>
Database changed
mysql<span class="token operator">&gt;</span> <span class="token constant">SHOW</span> <span class="token constant">TABLES</span><span class="token punctuation">;</span>         <span class="token comment">#查看当前库中的表</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token class-name">Tables_in_employees</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token class-name">departments</span>         <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">dept_emp</span>            <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">dept_manager</span>        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">employees</span>           <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">salaries</span>            <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">titles</span>              <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token number">6</span> rows in <span class="token function">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token constant">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token constant">FROM</span> employees<span class="token punctuation">;</span>   <span class="token comment">#由于篇幅原因, 我们这里只看一下employees的行数为300024</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token class-name">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span>   <span class="token number">300024</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token number">1</span> row in <span class="token function">set</span> <span class="token punctuation">(</span><span class="token number">0.05</span> sec<span class="token punctuation">)</span>


创建快照卷并备份


mysql<span class="token operator">&gt;</span> <span class="token constant">FLUSH</span> <span class="token constant">TABLES</span> <span class="token constant">WITH</span> <span class="token constant">READ</span> <span class="token constant">LOCK</span><span class="token punctuation">;</span>     <span class="token comment">#锁定所有表</span>
Query <span class="token constant">OK</span><span class="token punctuation">,</span> <span class="token number">0</span> rows <span class="token function">affected</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token punctuation">[</span>root@node1 lvm_data<span class="token punctuation">]</span><span class="token comment"># lvcreate -L 1G -n mydata-snap -p r -s /dev/mapper/myvg-mydata   #创建快照卷</span>
  Logical volume <span class="token string double-quoted-string">&quot;mydata-snap&quot;</span> created<span class="token operator">.</span>

mysql<span class="token operator">&gt;</span> <span class="token constant">UNLOCK</span> <span class="token constant">TABLES</span><span class="token punctuation">;</span>  <span class="token comment">#解锁所有表</span>
Query <span class="token constant">OK</span><span class="token punctuation">,</span> <span class="token number">0</span> rows <span class="token function">affected</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token punctuation">[</span>root@node1 lvm_data<span class="token punctuation">]</span><span class="token comment"># mkdir /lvm_snap  #创建文件夹</span>
<span class="token punctuation">[</span>root@node1 lvm_data<span class="token punctuation">]</span><span class="token comment"># mount /dev/myvg/mydata-snap /lvm_snap/  #挂载snap</span>
mount<span class="token punctuation">:</span> block device <span class="token operator">/</span>dev<span class="token operator">/</span>mapper<span class="token operator">/</span>myvg<span class="token operator">-</span>mydata<span class="token operator">--</span>snap is write<span class="token operator">-</span><span class="token keyword">protected</span><span class="token punctuation">,</span> mounting read<span class="token operator">-</span>only

<span class="token punctuation">[</span>root@node1 lvm_data<span class="token punctuation">]</span><span class="token comment"># cd /lvm_snap/</span>
<span class="token punctuation">[</span>root@node1 lvm_snap<span class="token punctuation">]</span><span class="token comment"># ls</span>
employees  ibdata1  ib_logfile0  ib_logfile1  mysql  mysql<span class="token operator">-</span>bin<span class="token operator">.</span><span class="token number">000001</span>  mysql<span class="token operator">-</span>bin<span class="token operator">.</span><span class="token number">000002</span>  mysql<span class="token operator">-</span>bin<span class="token operator">.</span><span class="token number">000003</span>  mysql<span class="token operator">-</span>bin<span class="token operator">.</span>index  test
<span class="token punctuation">[</span>root@node1 lvm_snap<span class="token punctuation">]</span><span class="token comment"># tar cf /tmp/mysqlback.tar *  #打包文件到/tmp/mysqlback.tar</span>

<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># umount /lvm_snap/  #卸载snap</span>
<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># lvremove myvg mydata-snap  #删除snap</span>


恢复数据


<span class="token punctuation">[</span>root@node1 lvm_snap<span class="token punctuation">]</span><span class="token comment"># rm -rf /lvm_data/*</span>
<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># service mysqld start    #启动MySQL, 如果是编译安装的应该不能启动(需重新初始化), 如果rpm安装则会重新初始化数据库</span>


mysql<span class="token operator">&gt;</span> <span class="token constant">SHOW</span> <span class="token constant">DATABASES</span><span class="token punctuation">;</span>   <span class="token comment">#查看数据库, 数据丢失!</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token class-name">Database</span>           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token class-name">information_schema</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">mysql</span>              <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">test</span>               <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token number">3</span> rows in <span class="token function">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># cd /lvm_data/</span>
<span class="token punctuation">[</span>root@node1 lvm_data<span class="token punctuation">]</span><span class="token comment"># rm -rf * #删除所有文件</span>
<span class="token punctuation">[</span>root@node1 lvm_data<span class="token punctuation">]</span><span class="token comment"># tar xf /tmp/mysqlback.tar     #解压备份数据库到此文件夹 </span>
<span class="token punctuation">[</span>root@node1 lvm_data<span class="token punctuation">]</span><span class="token comment"># ls  #查看当前的文件</span>
employees  ibdata1  ib_logfile0  ib_logfile1  mysql  mysql<span class="token operator">-</span>bin<span class="token operator">.</span><span class="token number">000001</span>  mysql<span class="token operator">-</span>bin<span class="token operator">.</span><span class="token number">000002</span>  mysql<span class="token operator">-</span>bin<span class="token operator">.</span><span class="token number">000003</span>  mysql<span class="token operator">-</span>bin<span class="token operator">.</span>index  test

mysql<span class="token operator">&gt;</span> <span class="token constant">SHOW</span> <span class="token constant">DATABASES</span><span class="token punctuation">;</span>  <span class="token comment">#数据恢复了</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token class-name">Database</span>           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token class-name">information_schema</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">employees</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">mysql</span>              <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">test</span>               <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token number">4</span> rows in <span class="token function">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="使用xtrabackup备份" tabindex="-1"><a class="header-anchor" href="#使用xtrabackup备份" aria-hidden="true">#</a> 使用Xtrabackup备份</h3><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code>为了更好地演示<span class="token punctuation">,</span> 我们这次使用mariadb<span class="token operator">-</span><span class="token number">5.5</span>的版本<span class="token punctuation">,</span> 使用xtrabackup使用InnoDB能够发挥其最大功效<span class="token punctuation">,</span> 
并且InnoDB的每一张表必须使用单独的表空间<span class="token punctuation">,</span> 我们需要在配置文件中添加 innodb_file_per_table <span class="token operator">=</span> <span class="token constant">ON</span> 来开启
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>下载安装xtrabackup</strong></li></ul><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code>我们这里通过wget percona官方的rpm包进行安装
<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># wget https://www.percona.com/downloads/XtraBackup/Percona-XtraBackup-2.3.4/binary/redhat/6/x86_64/percona-xtrabackup-2.3.4-1.el6.x86_64.rpm   </span>
<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># yum localinstall percona-xtrabackup-2.3.4-1.el6.x86_64.rpm   #需要EPEL源</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>xtrabackup介绍</strong></li></ul><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code>Xtrabackup是由percona提供的mysql数据库备份工具，据官方介绍，这也是世界上惟一一款开源的能够对innodb和xtradb数据库进行热备的工具。特点：

备份过程快速、可靠；

备份过程不会打断正在执行的事务；

能够基于压缩等功能节约磁盘空间和流量；

自动实现备份检验；

还原速度快；
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>xtrabackup实现完全备份</strong></li></ul><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code>我们这里使用xtrabackup的前端配置工具innobackupex来实现对数据库的完全备份

使用innobackupex备份时<span class="token punctuation">,</span> 会调用xtrabackup备份所有的InnoDB表<span class="token punctuation">,</span> 复制所有关于表结构定义的相关文件<span class="token punctuation">(</span><span class="token operator">.</span>frm<span class="token punctuation">)</span>、
以及MyISAM、<span class="token constant">MERGE</span>、<span class="token constant">CSV</span>和<span class="token constant">ARCHIVE</span>表的相关文件<span class="token punctuation">,</span> 同时还会备份触发器和数据库配置文件信息相关的文件<span class="token punctuation">,</span> 这些文件会被保存至一个以时间命名的目录<span class="token operator">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>备份过程</strong></li></ul><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># mkdir /extrabackup  #创建备份目录</span>
<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># innobackupex --user=root /extrabackup/ #备份数据</span>
<span class="token comment">###################提示complete表示成功*********************</span>

<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># ls /extrabackup/  #看到备份目录</span>

一般情况<span class="token punctuation">,</span> 备份完成后<span class="token punctuation">,</span> 数据不能用于恢复操作<span class="token punctuation">,</span> 
因为备份的数据中可能会包含尚未提交的事务或已经提交但尚未同步至数据文件中的事务。
因此<span class="token punctuation">,</span> 此时的数据文件仍不一致<span class="token punctuation">,</span> 所以我们需要<span class="token string double-quoted-string">&quot;准备&quot;</span>一个完全备份


<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># innobackupex --apply-log /extrabackup/2016-04-27_07-30-48/  #指定备份文件的目录</span>

<span class="token comment">#一般情况下下面三行结尾代表成功*****************</span>
InnoDB<span class="token punctuation">:</span> Starting shutdown<span class="token operator">...</span>
InnoDB<span class="token punctuation">:</span> Shutdown completed<span class="token punctuation">;</span> log sequence number <span class="token number">369661462</span>
<span class="token number">160427</span> <span class="token number">07</span><span class="token punctuation">:</span><span class="token number">40</span><span class="token punctuation">:</span><span class="token number">11</span> completed <span class="token constant">OK</span><span class="token operator">!</span>

<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># cd /extrabackup/2016-04-27_07-30-48/</span>
<span class="token punctuation">[</span>root@node1 <span class="token number">2016</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">27_07</span><span class="token operator">-</span><span class="token number">30</span><span class="token operator">-</span><span class="token number">48</span><span class="token punctuation">]</span><span class="token comment"># ls -hl  #查看备份文件</span>
total <span class="token number">31</span>M
<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token number">1</span> root root  <span class="token number">386</span> Apr <span class="token number">27</span> <span class="token number">07</span><span class="token punctuation">:</span><span class="token number">30</span> backup<span class="token operator">-</span>my<span class="token operator">.</span>cnf
drwx<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> <span class="token number">2</span> root root <span class="token number">4.0</span>K Apr <span class="token number">27</span> <span class="token number">07</span><span class="token punctuation">:</span><span class="token number">30</span> employees
<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token number">1</span> root root  <span class="token number">18</span>M Apr <span class="token number">27</span> <span class="token number">07</span><span class="token punctuation">:</span><span class="token number">40</span> ibdata1
<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">--</span>r<span class="token operator">--</span> <span class="token number">1</span> root root <span class="token number">5.0</span>M Apr <span class="token number">27</span> <span class="token number">07</span><span class="token punctuation">:</span><span class="token number">40</span> ib_logfile0
<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">--</span>r<span class="token operator">--</span> <span class="token number">1</span> root root <span class="token number">5.0</span>M Apr <span class="token number">27</span> <span class="token number">07</span><span class="token punctuation">:</span><span class="token number">40</span> ib_logfile1
drwx<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> <span class="token number">2</span> root root <span class="token number">4.0</span>K Apr <span class="token number">27</span> <span class="token number">07</span><span class="token punctuation">:</span><span class="token number">30</span> mysql
drwx<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> <span class="token number">2</span> root root <span class="token number">4.0</span>K Apr <span class="token number">27</span> <span class="token number">07</span><span class="token punctuation">:</span><span class="token number">30</span> performance_schema
drwx<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> <span class="token number">2</span> root root <span class="token number">4.0</span>K Apr <span class="token number">27</span> <span class="token number">07</span><span class="token punctuation">:</span><span class="token number">30</span> test
<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token number">1</span> root root   <span class="token number">27</span> Apr <span class="token number">27</span> <span class="token number">07</span><span class="token punctuation">:</span><span class="token number">30</span> xtrabackup_binlog_info
<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">--</span>r<span class="token operator">--</span> <span class="token number">1</span> root root   <span class="token number">29</span> Apr <span class="token number">27</span> <span class="token number">07</span><span class="token punctuation">:</span><span class="token number">40</span> xtrabackup_binlog_pos_innodb
<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token number">1</span> root root  <span class="token number">117</span> Apr <span class="token number">27</span> <span class="token number">07</span><span class="token punctuation">:</span><span class="token number">40</span> xtrabackup_checkpoints
<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token number">1</span> root root  <span class="token number">470</span> Apr <span class="token number">27</span> <span class="token number">07</span><span class="token punctuation">:</span><span class="token number">30</span> xtrabackup_info
<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token number">1</span> root root <span class="token number">2.0</span>M Apr <span class="token number">27</span> <span class="token number">07</span><span class="token punctuation">:</span><span class="token number">40</span> xtrabackup_logfile


恢复数据

<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># rm -rf /data/*   #删除数据文件</span>

<span class="token operator">**</span><span class="token operator">*</span>不用启动数据库也可以还原<span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">*</span>

<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># innobackupex --copy-back /extrabackup/2016-04-27_07-30-48/   #恢复数据, 记清使用方法</span>

<span class="token comment">#########我们这里是编译安装的mariadb所以需要做一些操作##########</span>
<span class="token punctuation">[</span>root@node1 data<span class="token punctuation">]</span><span class="token comment"># killall mysqld</span>

<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># chown -R mysql:mysql ./* </span>
<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># ll /data/      #数据恢复</span>
total <span class="token number">28704</span>
<span class="token operator">-</span>rw<span class="token operator">-</span>rw<span class="token operator">--</span><span class="token operator">--</span> <span class="token number">1</span> mysql mysql    <span class="token number">16384</span> Apr <span class="token number">27</span> <span class="token number">07</span><span class="token punctuation">:</span><span class="token number">43</span> aria_log<span class="token operator">.</span><span class="token number">00000001</span>
<span class="token operator">-</span>rw<span class="token operator">-</span>rw<span class="token operator">--</span><span class="token operator">--</span> <span class="token number">1</span> mysql mysql       <span class="token number">52</span> Apr <span class="token number">27</span> <span class="token number">07</span><span class="token punctuation">:</span><span class="token number">43</span> aria_log_control
<span class="token operator">-</span>rw<span class="token operator">-</span>rw<span class="token operator">--</span><span class="token operator">--</span> <span class="token number">1</span> mysql mysql <span class="token number">18874368</span> Apr <span class="token number">27</span> <span class="token number">07</span><span class="token punctuation">:</span><span class="token number">43</span> ibdata1
<span class="token operator">-</span>rw<span class="token operator">-</span>rw<span class="token operator">--</span><span class="token operator">--</span> <span class="token number">1</span> mysql mysql  <span class="token number">5242880</span> Apr <span class="token number">27</span> <span class="token number">07</span><span class="token punctuation">:</span><span class="token number">43</span> ib_logfile0
<span class="token operator">-</span>rw<span class="token operator">-</span>rw<span class="token operator">--</span><span class="token operator">--</span> <span class="token number">1</span> mysql mysql  <span class="token number">5242880</span> Apr <span class="token number">27</span> <span class="token number">07</span><span class="token punctuation">:</span><span class="token number">43</span> ib_logfile1
<span class="token operator">-</span>rw<span class="token operator">-</span>rw<span class="token operator">--</span><span class="token operator">--</span> <span class="token number">1</span> mysql mysql      <span class="token number">264</span> Apr <span class="token number">27</span> <span class="token number">07</span><span class="token punctuation">:</span><span class="token number">43</span> mysql<span class="token operator">-</span>bin<span class="token operator">.</span><span class="token number">000001</span>
<span class="token operator">-</span>rw<span class="token operator">-</span>rw<span class="token operator">--</span><span class="token operator">--</span> <span class="token number">1</span> mysql mysql       <span class="token number">19</span> Apr <span class="token number">27</span> <span class="token number">07</span><span class="token punctuation">:</span><span class="token number">43</span> mysql<span class="token operator">-</span>bin<span class="token operator">.</span>index
<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token number">1</span> mysql mysql     <span class="token number">2166</span> Apr <span class="token number">27</span> <span class="token number">07</span><span class="token punctuation">:</span><span class="token number">43</span> node1<span class="token operator">.</span>anyisalin<span class="token operator">.</span>com<span class="token operator">.</span>err


<span class="token punctuation">[</span>root@node1 data<span class="token punctuation">]</span><span class="token comment"># service mysqld restart</span>
MySQL server <span class="token constant">PID</span> file could not be found<span class="token operator">!</span>                  <span class="token punctuation">[</span><span class="token constant">FAILED</span><span class="token punctuation">]</span>
Starting MySQL<span class="token operator">.</span><span class="token operator">.</span>                                           <span class="token punctuation">[</span>  <span class="token constant">OK</span>  <span class="token punctuation">]</span>

MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token constant">SHOW</span> <span class="token constant">DATABASES</span><span class="token punctuation">;</span>  <span class="token comment">#查看数据库, 已经恢复</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token class-name">Database</span>           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token class-name">information_schema</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">employees</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">mysql</span>              <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">performance_schema</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">test</span>               <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token number">5</span> rows in <span class="token function">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec


增量备份


<span class="token comment">#########创建连两个数据库以供测试#####################</span>
MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token constant">CREATE</span> <span class="token constant">DATABASE</span> <span class="token constant">TEST1</span><span class="token punctuation">;</span>
Query <span class="token constant">OK</span><span class="token punctuation">,</span> <span class="token number">1</span> row <span class="token function">affected</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token constant">CREATE</span> <span class="token constant">DATABASE</span> <span class="token constant">TEST2</span><span class="token punctuation">;</span>
Query <span class="token constant">OK</span><span class="token punctuation">,</span> <span class="token number">1</span> row <span class="token function">affected</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># innobackupex --incremental /extrabackup/ --incremental-basedir=/extrabackup/2016-04-27_07-30-48/ </span>

<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># ls /extrabackup/2016-04-27_07-57-22/ #查看备份文件</span>
total <span class="token number">96</span>
<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token number">1</span> root root   <span class="token number">386</span> Apr <span class="token number">27</span> <span class="token number">07</span><span class="token punctuation">:</span><span class="token number">57</span> backup<span class="token operator">-</span>my<span class="token operator">.</span>cnf
drwx<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> <span class="token number">2</span> root root  <span class="token number">4096</span> Apr <span class="token number">27</span> <span class="token number">07</span><span class="token punctuation">:</span><span class="token number">57</span> employees
<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token number">1</span> root root <span class="token number">49152</span> Apr <span class="token number">27</span> <span class="token number">07</span><span class="token punctuation">:</span><span class="token number">57</span> ibdata1<span class="token operator">.</span>delta
<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token number">1</span> root root    <span class="token number">44</span> Apr <span class="token number">27</span> <span class="token number">07</span><span class="token punctuation">:</span><span class="token number">57</span> ibdata1<span class="token operator">.</span>meta
drwx<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> <span class="token number">2</span> root root  <span class="token number">4096</span> Apr <span class="token number">27</span> <span class="token number">07</span><span class="token punctuation">:</span><span class="token number">57</span> mysql
drwx<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> <span class="token number">2</span> root root  <span class="token number">4096</span> Apr <span class="token number">27</span> <span class="token number">07</span><span class="token punctuation">:</span><span class="token number">57</span> performance_schema
drwx<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> <span class="token number">2</span> root root  <span class="token number">4096</span> Apr <span class="token number">27</span> <span class="token number">07</span><span class="token punctuation">:</span><span class="token number">57</span> test
drwx<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> <span class="token number">2</span> root root  <span class="token number">4096</span> Apr <span class="token number">27</span> <span class="token number">07</span><span class="token punctuation">:</span><span class="token number">57</span> <span class="token constant">TEST1</span>
drwx<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> <span class="token number">2</span> root root  <span class="token number">4096</span> Apr <span class="token number">27</span> <span class="token number">07</span><span class="token punctuation">:</span><span class="token number">57</span> <span class="token constant">TEST2</span>
<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token number">1</span> root root    <span class="token number">21</span> Apr <span class="token number">27</span> <span class="token number">07</span><span class="token punctuation">:</span><span class="token number">57</span> xtrabackup_binlog_info
<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token number">1</span> root root   <span class="token number">123</span> Apr <span class="token number">27</span> <span class="token number">07</span><span class="token punctuation">:</span><span class="token number">57</span> xtrabackup_checkpoints
<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token number">1</span> root root   <span class="token number">530</span> Apr <span class="token number">27</span> <span class="token number">07</span><span class="token punctuation">:</span><span class="token number">57</span> xtrabackup_info
<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token number">1</span> root root  <span class="token number">2560</span> Apr <span class="token number">27</span> <span class="token number">07</span><span class="token punctuation">:</span><span class="token number">57</span> xtrabackup_logfile


<span class="token constant">BASEDIR</span>指的是完全备份所在的目录，此命令执行结束后，
innobackupex命令会在<span class="token operator">/</span>extrabackup目录中创建一个新的以时间命名的目录以存放所有的增量备份数据。
另外，在执行过增量备份之后再一次进行增量备份时，其<span class="token operator">--</span>incremental<span class="token operator">-</span>basedir应该指向上一次的增量备份所在的目录。

需要注意的是，增量备份仅能应用于InnoDB或XtraDB表，对于MyISAM表而言，执行增量备份时其实进行的是完全备份。


整理增量备份
<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># innobackupex --apply-log --redo-only /extrabackup/2016-04-27_07-30-48/</span>
<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># innobackupex --apply-log --redo-only /extrabackup/2016-04-27_07-30-48/ --incremental-dir=/extrabackup/2016-04-27_07-57-22/</span>


恢复数据

<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># rm -rf /data/*   #删除数据</span>

<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># innobackupex --copy-back /extrabackup/2016-04-27_07-30-48/     #整理增量备份之后可以直接通过全量备份还原</span>

<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># chown -R mysql.mysql /data/</span>
<span class="token punctuation">[</span>root@node1 <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># ls /data/ -l</span>
total <span class="token number">28732</span>
<span class="token operator">-</span>rw<span class="token operator">-</span>rw<span class="token operator">--</span><span class="token operator">--</span> <span class="token number">1</span> mysql mysql     <span class="token number">8192</span> Apr <span class="token number">27</span> <span class="token number">08</span><span class="token punctuation">:</span><span class="token number">05</span> aria_log<span class="token operator">.</span><span class="token number">00000001</span>
<span class="token operator">-</span>rw<span class="token operator">-</span>rw<span class="token operator">--</span><span class="token operator">--</span> <span class="token number">1</span> mysql mysql       <span class="token number">52</span> Apr <span class="token number">27</span> <span class="token number">08</span><span class="token punctuation">:</span><span class="token number">05</span> aria_log_control
drwx<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> <span class="token number">2</span> mysql mysql     <span class="token number">4096</span> Apr <span class="token number">27</span> <span class="token number">08</span><span class="token punctuation">:</span><span class="token number">05</span> employees
<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token number">1</span> mysql mysql <span class="token number">18874368</span> Apr <span class="token number">27</span> <span class="token number">08</span><span class="token punctuation">:</span><span class="token number">05</span> ibdata1
<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token number">1</span> mysql mysql  <span class="token number">5242880</span> Apr <span class="token number">27</span> <span class="token number">08</span><span class="token punctuation">:</span><span class="token number">05</span> ib_logfile0
<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token number">1</span> mysql mysql  <span class="token number">5242880</span> Apr <span class="token number">27</span> <span class="token number">08</span><span class="token punctuation">:</span><span class="token number">05</span> ib_logfile1
drwx<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> <span class="token number">2</span> mysql mysql     <span class="token number">4096</span> Apr <span class="token number">27</span> <span class="token number">08</span><span class="token punctuation">:</span><span class="token number">05</span> mysql
<span class="token operator">-</span>rw<span class="token operator">-</span>rw<span class="token operator">--</span><span class="token operator">--</span> <span class="token number">1</span> mysql mysql      <span class="token number">245</span> Apr <span class="token number">27</span> <span class="token number">08</span><span class="token punctuation">:</span><span class="token number">05</span> mysql<span class="token operator">-</span>bin<span class="token operator">.</span><span class="token number">000001</span>
<span class="token operator">-</span>rw<span class="token operator">-</span>rw<span class="token operator">--</span><span class="token operator">--</span> <span class="token number">1</span> mysql mysql       <span class="token number">19</span> Apr <span class="token number">27</span> <span class="token number">08</span><span class="token punctuation">:</span><span class="token number">05</span> mysql<span class="token operator">-</span>bin<span class="token operator">.</span>index
<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token number">1</span> mysql mysql     <span class="token number">1812</span> Apr <span class="token number">27</span> <span class="token number">08</span><span class="token punctuation">:</span><span class="token number">05</span> node1<span class="token operator">.</span>anyisalin<span class="token operator">.</span>com<span class="token operator">.</span>err
<span class="token operator">-</span>rw<span class="token operator">-</span>rw<span class="token operator">--</span><span class="token operator">--</span> <span class="token number">1</span> mysql mysql        <span class="token number">5</span> Apr <span class="token number">27</span> <span class="token number">08</span><span class="token punctuation">:</span><span class="token number">05</span> node1<span class="token operator">.</span>anyisalin<span class="token operator">.</span>com<span class="token operator">.</span>pid
drwx<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> <span class="token number">2</span> mysql mysql     <span class="token number">4096</span> Apr <span class="token number">27</span> <span class="token number">08</span><span class="token punctuation">:</span><span class="token number">05</span> performance_schema
drwx<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> <span class="token number">2</span> mysql mysql     <span class="token number">4096</span> Apr <span class="token number">27</span> <span class="token number">08</span><span class="token punctuation">:</span><span class="token number">05</span> test
drwx<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> <span class="token number">2</span> mysql mysql     <span class="token number">4096</span> Apr <span class="token number">27</span> <span class="token number">08</span><span class="token punctuation">:</span><span class="token number">05</span> <span class="token constant">TEST1</span>
drwx<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> <span class="token number">2</span> mysql mysql     <span class="token number">4096</span> Apr <span class="token number">27</span> <span class="token number">08</span><span class="token punctuation">:</span><span class="token number">05</span> <span class="token constant">TEST2</span>
<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token number">1</span> mysql mysql       <span class="token number">29</span> Apr <span class="token number">27</span> <span class="token number">08</span><span class="token punctuation">:</span><span class="token number">05</span> xtrabackup_binlog_pos_innodb
<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token number">1</span> mysql mysql      <span class="token number">530</span> Apr <span class="token number">27</span> <span class="token number">08</span><span class="token punctuation">:</span><span class="token number">05</span> xtrabackup_info

MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token constant">SHOW</span> <span class="token constant">DATABASES</span><span class="token punctuation">;</span>  <span class="token comment">#数据还原</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token class-name">Database</span>           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token class-name">information_schema</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">TEST1</span>              <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">TEST2</span>              <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">employees</span>          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">mysql</span>              <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">performance_schema</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token class-name">test</span>               <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token number">7</span> rows in <span class="token function">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token comment">#关于xtrabackup还有很多强大的功能没有叙述、有兴趣可以去看官方文档</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h3><table><thead><tr><th style="text-align:left;">备份方法</th><th style="text-align:left;">备份速度</th><th style="text-align:left;">恢复速度</th><th style="text-align:left;">便捷性</th><th style="text-align:left;">功能</th><th style="text-align:left;">一般用于</th></tr></thead><tbody><tr><td style="text-align:left;">cp</td><td style="text-align:left;">快</td><td style="text-align:left;">快</td><td style="text-align:left;">一般、灵活性低</td><td style="text-align:left;">很弱</td><td style="text-align:left;">少量数据备份</td></tr><tr><td style="text-align:left;">mysqldump</td><td style="text-align:left;">慢</td><td style="text-align:left;">慢</td><td style="text-align:left;">一般、可无视存储引擎的差异</td><td style="text-align:left;">一般</td><td style="text-align:left;">中小型数据量的备份</td></tr><tr><td style="text-align:left;">lvm2快照</td><td style="text-align:left;">快</td><td style="text-align:left;">快</td><td style="text-align:left;">一般、支持几乎热备、速度快</td><td style="text-align:left;">一般</td><td style="text-align:left;">中小型数据量的备份</td></tr><tr><td style="text-align:left;">xtrabackup</td><td style="text-align:left;">较快</td><td style="text-align:left;">较快</td><td style="text-align:left;">实现innodb热备、对存储引擎有要求</td><td style="text-align:left;">强大</td><td style="text-align:left;">较大规模的备份</td></tr></tbody></table>`,34),l=[t];function r(c,i){return n(),a("div",null,l)}const u=s(o,[["render",r],["__file","06.html.vue"]]);export{u as default};
