(window.webpackJsonp=window.webpackJsonp||[]).push([[296],{789:function(s,a,t){"use strict";t.r(a);var n=t(5),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h3",{attrs:{id:"数据库配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#数据库配置"}},[s._v("#")]),s._v(" 数据库配置")]),s._v(" "),t("p",[s._v("我们给应用定义数据库配置文件（"),t("code",[s._v("appliation/database.php")]),s._v("），里面设置了应用的全局数据库配置信息。")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("return [\n    // 数据库类型\n    'type'        => 'mysql',\n    // 服务器地址\n    'hostname'    => '127.0.0.1',\n    // 数据库名\n    'database'    => 'test',\n    // 数据库用户名\n    'username'    => 'root',\n    // 数据库密码\n    'password'    => '',\n    // 数据库连接端口\n    'hostport'    => '',\n    // 数据库连接参数\n    'params'      => [],\n    // 数据库编码默认采用utf8\n    'charset'     => 'utf8',\n    // 数据库表前缀\n    'prefix'      => '',\n    // 数据库调试模式\n    'debug'       => true,\n];\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br")])]),t("h4",{attrs:{id:"配置长链接"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置长链接"}},[s._v("#")]),s._v(" 配置长链接")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("return [\n    // 数据库名\n    'database'    => 'demo',\n    // 数据库表前缀\n    'prefix'      => 'think_',\n    // 数据库连接参数\n    'params' => [\n        // 使用长连接\n        \\PDO::ATTR_PERSISTENT => true,\n    ],    \n];\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("h4",{attrs:{id:"原生查询"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#原生查询"}},[s._v("#")]),s._v(" 原生查询")]),s._v(" "),t("p",[s._v("设置好数据库连接信息后，我们就可以直接进行原生的SQL查询操作了，包括"),t("code",[s._v("query")]),s._v("和"),t("code",[s._v("execute")]),s._v("两个方法，分别用于查询操作和写操作，下面我们来实现数据表"),t("code",[s._v("think_data")]),s._v("的"),t("code",[s._v("CURD")]),s._v("操作。")]),s._v(" "),t("blockquote",[t("ul",[t("li",[s._v("创建（create）")])])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("// 插入记录\n$result = Db::execute('insert into think_data (id, name ,status) values (5, \"thinkphp\",1)');\ndump($result);\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("blockquote",[t("ul",[t("li",[s._v("更新（update）")])])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("// 更新记录\n$result = Db::execute('update think_data set name = \"framework\" where id = 5 ');\ndump($result);\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("blockquote",[t("ul",[t("li",[s._v("读取（read）")])])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("// 查询数据\n$result = Db::query('select * from think_data where id = 5');\ndump($result);\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("blockquote",[t("ul",[t("li",[s._v("删除（delete）")])])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("// 删除数据\n$result = Db::execute('delete from think_data where id = 5 ');\ndump($result);\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("blockquote",[t("ul",[t("li",[s._v("其它操作")])])]),s._v(" "),t("p",[s._v("可以执行一些其他的数据库操作，原则上，读操作都使用"),t("code",[s._v("query")]),s._v("方法，写操作使用"),t("code",[s._v("execute")]),s._v("方法即可，例如：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("// 显示数据库列表\n$result = Db::query('show tables from demo');\ndump($result);\n\n\n// 清空数据表\n$result = Db::execute('TRUNCATE table think_data');\ndump($result);\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("h3",{attrs:{id:"查询构造器"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#查询构造器"}},[s._v("#")]),s._v(" 查询构造器")]),s._v(" "),t("p",[s._v("除了原生查询外，5.0还提供了数据库查询构造器，可以更方便执行数据库操作，查询构造器基于PDO实现，对不同的数据库驱动都是统一的语法。")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("// 插入记录\nDb::table('think_data')\n    ->insert(['id' => 18, 'name' => 'thinkphp', 'status' => 1]);\n\n// 更新记录\nDb::table('think_data')\n    ->where('id', 18)\n    ->update(['name' => \"hello\"]);\n\n// 查询数据\n$list = Db::table('think_data')\n\t->field('name,email')\n    ->where('id', 18)\n    ->select();\n\n// 删除数据\nDb::table('think_data')\n    ->where('id', 18)\n    ->delete();\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br")])]),t("p",[s._v("由于我们在数据库配置文件中设置了数据表的前缀为"),t("code",[s._v("think_")]),s._v("，因此，"),t("code",[s._v("table")]),s._v("方法可以改成"),t("code",[s._v("name")]),s._v("方法，这样就不会因为数据表前缀的修改而改动"),t("code",[s._v("CURD")]),s._v("代码，例如：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("// 插入记录\nDb::name('data')\n    ->insert(['id' => 18, 'name' => 'thinkphp']);\n\n// 更新记录\nDb::name('data')\n    ->where('id', 18)\n    ->update(['name' => \"framework\"]);\n\n// 查询数据\n$list = Db::name('data')\n    ->where('id', 18)\n    ->select();\ndump($list);\n\n// 删除数据\nDb::name('data')\n    ->where('id', 18)\n    ->delete();\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br")])]),t("p",[s._v("如果使用系统提供的助手函数"),t("code",[s._v("db")]),s._v("则可以进一步简化查询代码如下：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("$db = db('data');\n// 插入记录\n$db->insert(['id' => 20, 'name' => 'thinkphp']);\n\n// 更新记录\n$db->where('id', 20)->update(['name' => \"framework\"]);\n\n// 查询数据\n$list = $db->where('id', 20)->select();\ndump($list);\n\n// 删除数据\n$db->where('id', 20)->delete();\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("h3",{attrs:{id:"链式操作"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#链式操作"}},[s._v("#")]),s._v(" 链式操作")]),s._v(" "),t("p",[s._v("使用链式操作可以完成复杂的数据库查询操作，例如：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("// 查询十个满足条件的数据 并按照id倒序排列\n$list = Db::name('data')\n    ->where('status', 1)\n    ->field('id,name')\n    ->order('id', 'desc')\n    ->limit(10)\n    ->select();\ndump($list);\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[s._v("链式操作不分先后，只要在查询方法（这里是"),t("code",[s._v("select")]),s._v("方法）之前调用就行，所以，下面的查询是等效的：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("// 查询十个满足条件的数据 并按照id倒序排列\n$list = Db::name('data')\n    ->field('id,name')\n    ->order('id', 'desc')\n    ->where('status', 1)\n    ->limit(10)\n    ->select();\ndump($list);\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[s._v("支持链式操作的查询方法包括：")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",{staticStyle:{"text-align":"left"}},[s._v("方法名")]),s._v(" "),t("th",{staticStyle:{"text-align":"left"}},[s._v("描述")])])]),s._v(" "),t("tbody",[t("tr",[t("td",{staticStyle:{"text-align":"left"}},[s._v("select")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("查询数据集")])]),s._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"left"}},[s._v("find")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("查询单个记录")])]),s._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"left"}},[s._v("insert")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("插入记录")])]),s._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"left"}},[s._v("update")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("更新记录")])]),s._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"left"}},[s._v("delete")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("删除记录")])]),s._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"left"}},[s._v("value")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("查询值")])]),s._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"left"}},[s._v("column")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("查询列")])]),s._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"left"}},[s._v("chunk")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("分块查询")])]),s._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"left"}},[s._v("count等")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("聚合查询")])])])]),s._v(" "),t("h3",{attrs:{id:"事务支持"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#事务支持"}},[s._v("#")]),s._v(" 事务支持")]),s._v(" "),t("p",[s._v("对于事务的支持，最简单的方法就是使用"),t("code",[s._v("transaction")]),s._v("方法，只需要把需要执行的事务操作封装到闭包里面即可自动完成事务，例如：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("Db::transaction(function () {\n    Db::table('think_user')\n        ->delete(1);\n    Db::table('think_data')\n        ->insert(['id' => 28, 'name' => 'thinkphp', 'status' => 1]);\n});\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("一旦"),t("code",[s._v("think_data")]),s._v("表写入失败的话，系统会自动回滚，写入成功的话系统会自动提交当前事务。")]),s._v(" "),t("p",[s._v("也可以手动控制事务的提交，上面的实现代码可以改成：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("// 启动事务\nDb::startTrans();\ntry {\n    Db::table('think_user')\n        ->delete(1);\n    Db::table('think_data')\n        ->insert(['id' => 28, 'name' => 'thinkphp', 'status' => 1]);\n    // 提交事务\n    Db::commit();\n} catch (\\Exception $e) {\n    // 回滚事务\n    Db::rollback();\n}\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])])])}),[],!1,null,null,null);a.default=e.exports}}]);